{"version":3,"file":"index.js","sources":["../src/utils/index.js","../src/index.js"],"sourcesContent":["export function getType(value) {\n  switch (typeof value) {\n    case 'undefined': return undefined;\n    case 'number': return Number;\n    case 'boolean': return Boolean;\n    case 'object':\n      if (value === null) return null;\n      if (Array.isArray(value)) return Array;\n      return Object;\n    case 'function': return Function;\n    case 'string':\n    default: return String;\n  }\n}\n\nexport function coerceToType(value, type) {\n  switch (type) {\n    case String:\n    case Number:\n      return type(value);\n    case Boolean:\n      if (value === 'false' || (!value && value !== '')) return false;\n      return true;\n    case Array:\n      if (Array.isArray(value)) return value;\n      if (typeof value === 'string') {\n        return /^\\[.*\\]$/.test(value) ? JSON.parse(value) : [];\n      }\n      if (value) return type(value);\n      return [];\n    case Object:\n      return JSON.parse(value);\n    case Function:\n      return undefined;\n    default: return undefined;\n  }\n}\n\nexport function setAttr(host, attrName, type, val, oldValue) {\n  if (val !== oldValue) {\n    switch (type) {\n      case null:\n      case undefined:\n        break;\n      case Boolean:\n        if (val) {\n          host.setAttribute(attrName, '');\n        } else {\n          host.removeAttribute(attrName);\n        }\n        break;\n      case Array:\n        if (val === undefined || val === null || val.length === 0) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, JSON.stringify(val));\n        }\n        break;\n      case Object:\n        if (val === undefined || val === null || Object.keys(val).length === 0) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, JSON.stringify(val));\n        }\n        break;\n      case Function:\n        break;\n      case String:\n        if (val === '' || val === undefined || val === null) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, val);\n        }\n        break;\n      case Number:\n      default:\n        if (val === undefined || val === null) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, val);\n        }\n        break;\n    }\n  }  \n}\n","import { property } from 'hybrids';\nimport { camelToDash } from 'hybrids/src/utils';\nimport { getType, coerceToType, setAttr } from './utils';\n\n// Keep track of any instances of any components that use reflected attributes.\nconst hosts = new WeakMap();\n\n// Keep track of all reflected attributes, by component tag name.\nconst reflectedAttributes = new Map();\n\nexport default function reflect(value, methods = {}) {\n  let type;\n  let attrName;\n  let observer;\n  const properties = {\n    ...property(value, function connect(host, key) {\n      type = getType(value);\n      attrName = camelToDash(key);\n      const tagName = host.tagName;\n\n      // Assign all reflected attributes to a map whose lookup is the tagName.\n      const attrMap = reflectedAttributes.get(tagName) || new Map();\n      reflectedAttributes.set(tagName, attrMap.set(attrName, {key, type}));\n\n      // Set coerced value for key, as derived from attribute.\n      const attrValue = host.getAttribute(attrName);\n      if (attrValue !== null) {\n        value = coerceToType(attrValue, type);\n        host[key] = value;\n      }\n\n      // Only assign a single mutation observer to watch any single host, no matter how many reflected keys it has.\n      const hasObserver = hosts.get(host);\n      if (!hasObserver) {\n        observer = new MutationObserver((mutations) => {\n          const watchedAttrs = reflectedAttributes.get(tagName);\n          mutations.forEach(({ attributeName, target }) => {\n            const watchedAttr = watchedAttrs.get(attributeName);\n            if (watchedAttr) {\n              const {key, type} = watchedAttr;\n              const attrValue = target.getAttribute(attributeName);\n              const value = coerceToType(attrValue, type);\n              if (value !== host[key]) {\n                target[key] = value;\n              }\n            }\n          });\n        });\n        hosts.set(host, true);\n        observer.observe(host, { attributes: true });\n      }\n\n      // Call any individually defined `connect` method the property may have.\n      let disconnectFn;\n      if (methods.connect) {\n        disconnectFn = methods.connect(host, key);\n      }\n\n      // Once a host disconnects, stop watching it and remove it from WeakMap.\n      // Only run code once no matter how many reflected keys it has.\n      return () => {\n        disconnectFn && disconnectFn();\n        if (observer) {\n          observer.disconnect();\n          hosts.delete(host);  \n        }\n      }\n    }),\n  }\n  const _get = properties.get;\n  properties.get = (host, val = value) => {\n    return methods.get ? methods.get(host, val) : _get(host, val);\n  };\n  const _set = properties.set;\n  properties.set = (host, val, oldValue) => {\n    return methods.set ? methods.set(host, val, oldValue) : _set(host, val, oldValue);\n  };\n  properties.observe = (host, value, oldValue) => {\n    setAttr(host, attrName, type, value, oldValue)\n    if (methods.observe) methods.observe(host, value, oldValue);\n  };\n  return properties;\n}\n\nexport {\n  getType,\n  coerceToType,\n}\n"],"names":["getType","value","undefined","Number","Boolean","Array","isArray","Object","Function","String","coerceToType","type","test","JSON","parse","setAttr","host","attrName","val","oldValue","setAttribute","removeAttribute","length","stringify","keys","hosts","WeakMap","reflectedAttributes","Map","reflect","methods","observer","properties","property","connect","key","camelToDash","tagName","attrMap","get","set","attrValue","getAttribute","hasObserver","MutationObserver","mutations","watchedAttrs","forEach","attributeName","target","watchedAttr","observe","attributes","disconnectFn","disconnect","delete","_get","_set"],"mappings":"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"}
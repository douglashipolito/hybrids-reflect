{"version":3,"file":"index.js","sources":["../src/utils/index.js","../src/index.js"],"sourcesContent":["export function getType(value) {\n  switch (typeof value) {\n    case \"undefined\":\n      return undefined;\n    case \"number\":\n      return Number;\n    case \"boolean\":\n      return Boolean;\n    case \"object\":\n      if (value === null) return null;\n      if (Array.isArray(value)) return Array;\n      return Object;\n    case \"function\":\n      return Function;\n    case \"string\":\n    default:\n      return String;\n  }\n}\n\nexport function coerceToType(value, type) {\n  switch (type) {\n    case String:\n    case Number:\n      if (value == undefined) return;\n      return type(value);\n    case Boolean:\n      if (value === \"false\" || (!value && value !== \"\")) return false;\n      return true;\n    case Array:\n      if (Array.isArray(value)) return value;\n      if (typeof value === \"string\") {\n        return /^\\[.*\\]$/.test(value) ? JSON.parse(value) : [];\n      }\n      if (value) return type(value);\n      return [];\n    case Object:\n      return JSON.parse(value);\n    case Function:\n      return undefined;\n    default:\n      return undefined;\n  }\n}\n\nexport function setAttr(host, attrName, type, val, oldValue) {\n  if (val !== oldValue) {\n    switch (type) {\n      case null:\n      case undefined:\n        break;\n      case Boolean:\n        if (val) {\n          host.setAttribute(attrName, \"\");\n        } else {\n          host.removeAttribute(attrName);\n        }\n        break;\n      case Array:\n        if (val === undefined || val === null || val.length === 0) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, JSON.stringify(val));\n        }\n        break;\n      case Object:\n        if (\n          val === undefined ||\n          val === null ||\n          Object.keys(val).length === 0\n        ) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, JSON.stringify(val));\n        }\n        break;\n      case Function:\n        break;\n      case String:\n        if (val === \"\" || val === undefined || val === null) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, val);\n        }\n        break;\n      case Number:\n      default:\n        if (val === undefined || val === null) {\n          host.removeAttribute(attrName);\n        } else {\n          host.setAttribute(attrName, val);\n        }\n        break;\n    }\n  }\n}\n","import { property } from \"hybrids\";\nimport { camelToDash } from \"hybrids/src/utils\";\nimport { getType, coerceToType, setAttr } from \"./utils\";\n\n// Keep track of any instances of any components that use reflected attributes.\nconst hosts = new WeakMap();\n\n// Keep track of all reflected attributes, by component tag name.\nconst reflectedAttributes = new Map();\n\nexport default function reflect(value, methods = {}) {\n  let type;\n  let attrName;\n  let observer;\n  let reflectedValue = value;\n  const properties = {\n    ...property(reflectedValue, function connect(host, key) {\n      type = methods.type || getType(reflectedValue);\n      attrName = camelToDash(key);\n      const tagName = host.tagName;\n\n      // Assign all reflected attributes to a map whose lookup is the tagName.\n      const attrMap = reflectedAttributes.get(tagName) || new Map();\n      reflectedAttributes.set(tagName, attrMap.set(attrName, { key, type }));\n\n      // Set coerced value for key, as derived from attribute.\n      const attrValue = host.getAttribute(attrName);\n      if (attrValue !== null) {\n        reflectedValue = coerceToType(attrValue, type);\n        host[key] = reflectedValue;\n      }\n\n      // Only assign a single mutation observer to watch any single host, no matter how many reflected keys it has.\n      const hasObserver = hosts.get(host);\n      if (!hasObserver) {\n        observer = new MutationObserver((mutations) => {\n          const watchedAttrs = reflectedAttributes.get(tagName);\n          mutations.forEach(({ attributeName, target }) => {\n            const watchedAttr = watchedAttrs.get(attributeName);\n            if (watchedAttr) {\n              const { key, type } = watchedAttr;\n              const attrValue = target.getAttribute(attributeName);\n              const reflectedValue = coerceToType(attrValue, type);\n              if (reflectedValue != undefined && reflectedValue !== host[key]) {\n                target[key] = reflectedValue;\n              }\n            }\n          });\n        });\n        hosts.set(host, true);\n        observer.observe(host, { attributes: true });\n      }\n\n      // Call any individually defined `connect` method the property may have.\n      let disconnectFn;\n      if (methods.connect) {\n        disconnectFn = methods.connect(host, key);\n      }\n\n      // Once a host disconnects, stop watching it and remove it from WeakMap.\n      // Only run code once no matter how many reflected keys it has.\n      return () => {\n        disconnectFn && disconnectFn();\n        if (observer) {\n          observer.disconnect();\n          hosts.delete(host);\n        }\n      };\n    }),\n  };\n  const _get = properties.get;\n  properties.get = (host, val = value) => {\n    return methods.get ? methods.get(host, val) : _get(host, val);\n  };\n  const _set = properties.set;\n  properties.set = (host, val, oldValue) => {\n    return methods.set\n      ? methods.set(host, val, oldValue)\n      : _set(host, val, oldValue);\n  };\n  properties.observe = (host, val, oldValue) => {\n    setAttr(host, attrName, type, val, oldValue);\n    if (methods.observe) methods.observe(host, val, oldValue);\n  };\n  return properties;\n}\n\nexport { getType, coerceToType };\n"],"names":["getType","value","undefined","Number","Boolean","Array","isArray","Object","Function","String","coerceToType","type","test","JSON","parse","setAttr","host","attrName","val","oldValue","setAttribute","removeAttribute","length","stringify","keys","hosts","WeakMap","reflectedAttributes","Map","reflect","methods","observer","reflectedValue","properties","property","connect","key","camelToDash","tagName","attrMap","get","set","attrValue","getAttribute","hasObserver","MutationObserver","mutations","watchedAttrs","forEach","attributeName","target","watchedAttr","observe","attributes","disconnectFn","disconnect","delete","_get","_set"],"mappings":"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"}